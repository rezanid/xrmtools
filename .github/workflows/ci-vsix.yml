name: CI - VSIX

on:
  pull_request:
    branches: [52-cicd]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/**"
      - "!.github/workflows/ci.yml"
      - "src/XrmTools.Meta.Attributes/**" 
  push:
    branches: [52-cicd]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "src/XrmTools.Meta.Attributes/**" 
  workflow_dispatch:

permissions:
  contents: write # required to push tags
  actions: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CONFIGURATION: "Release"

  SOLUTION_PATH: "src/XrmGen.sln"
  VSIX_PROJECT_DIR: "src/XrmTools/"
  NUGET_PROJECT_PATH: "src/XrmTools.Meta.Attributes/XrmTools.Meta.Attributes.msbuildproj"

  VSIX_MANIFEST_PATH: "src/XrmTools/source.extension.vsixmanifest"
  VSIX_MANIFEST_SOURCE_PATH: "src/XrmTools/source.extension.cs"

  ARTIFACTS_DIR: "artifacts"
  TEST_RESULTS_DIR: "artifacts/test-results"
  COVERAGE_DIR: "artifacts/coverage"

jobs:
  build:
    name: Build & Test
    runs-on: windows-latest

    outputs:
      vsix-version: ${{ steps.vsix-version.outputs.version-number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: timheuer/bootstrap-dotnet@v1
        with:
          msbuild: 'true'
          nuget: 'false'
          sdk: 'false'

      - name: Stamp VSIX revision from run number
        id: vsix_version
        uses: timheuer/vsix-version-stamp@v2
        with:
          manifest-file: ${{ env.VSIX_MANIFEST_PATH }}
          vsix-token-source-file: ${{ env.VSIX_MANIFEST_SOURCE_PATH }}
          version-type: revision
          build-number: ${{ github.run_number }}

      - name: Build
        run: msbuild "${{ env.SOLUTION_PATH }}" /v:m -restore /p:Configuration=${{ env.CONFIGURATION }} /p:OutDir=_built\

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix
          path: ${{env.VSIX_PROJECT_DIR}}_built/**/*.vsix

  publish_openvsix_and_tag:
    name: Publish Nightly (Open VSIX) + Tag
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    needs: build
    runs-on: windows-latest

    env:
      NIGHTLY_TAG: nightly/${{ needs.build.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: vsix

      - name: Publish to Open VSIX Gallery (nightly)
        uses: timheuer/openvsixpublish@v1
        with:
          vsix-file: "**/*.vsix"

      - name: Guard - nightly tag must not already exist
        shell: pwsh
        run: |
          $tag = "${{ env.NIGHTLY_TAG }}"
          git fetch --tags --force
          if (git tag -l $tag) { throw "Nightly tag '$tag' already exists. Refusing to overwrite." }

      - name: Create and push nightly tag
        shell: pwsh
        run: |
          $tag = "${{ env.NIGHTLY_TAG }}"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $tag
          git push origin $tag

      - name: Write summary
        shell: pwsh
        run: |
          $version = "${{ needs.build.outputs.version }}"
          $tag = "${{ env.NIGHTLY_TAG }}"
          "### VSIX nightly published" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "- Version: **$version**" | Out-File -Append $env:GITHUB_STEP_SUMMARY
          "- Tag: **$tag**" | Out-File -Append $env:GITHUB_STEP_SUMMARY